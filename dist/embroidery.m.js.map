{"version":3,"file":"embroidery.m.js","sources":["../lib/index.ts","../lib/utils.ts","../lib/controller.ts"],"sourcesContent":["import Controller from './controller'\nimport { domReady } from './utils'\n\nenum Data {\n  Controller = '[data-controller]',\n  Partial = '[data-partial]',\n}\n\nenum DataAttribute {\n  Controller = 'controller',\n  Partial = 'partial',\n}\n\ntype Callback = (el: Element) => void\n\ntype Cache = {\n  [DataAttribute.Controller]: Element[]\n  [DataAttribute.Partial]: Element[]\n}\n\nexport class Embroidery {\n  private cache: Cache = {\n    [DataAttribute.Controller]: [],\n    [DataAttribute.Partial]: [],\n  }\n\n  private context\n\n  static start() {\n    const app = new Embroidery()\n    app.start()\n    return app\n  }\n\n  constructor() {}\n\n  async start() {\n    await domReady()\n    console.info('Embroidery started.')\n\n    this.discover((el) => {\n      this.initialize(el)\n    }, Data.Controller)\n  }\n\n  register(controller) {\n    this.context = { ...controller }\n  }\n\n  discover(callback: Callback, type: Data) {\n    document\n      .querySelectorAll(type)\n      .forEach((controller: Element) => callback(controller))\n  }\n\n  updateCache(element, type) {\n    this.cache = { ...this.cache, [type]: [...this.cache[type], element] }\n  }\n\n  initialize(e: Element) {\n    const element = e as HTMLElement\n    if (element.dataset) {\n      try {\n        Object.keys(element.dataset).forEach((el) => {\n          switch (el) {\n            case DataAttribute.Controller:\n              this.updateCache(element, DataAttribute.Controller)\n              return new Controller(element, this.context)\n\n            case DataAttribute.Partial:\n              this.updateCache(element, DataAttribute.Partial)\n            // return new Partial(ele>ment)\n            default:\n              throw new Error(\n                'Element is not a specified data type, like Controller or Partial'\n              )\n          }\n        })\n      } catch (error) {\n        setTimeout(() => {\n          throw error\n        }, 0)\n      }\n    } else {\n      console.error(\n        `An element ${element} was picked up but could not be initialized`\n      )\n    }\n  }\n\n  discoverUninitializedControllers(\n    callback: Callback,\n    parentElement: Element = null\n  ) {\n    return Array.from(\n      (parentElement || document).querySelectorAll(Data.Controller)\n    )\n      .filter((element) => !this.cache[Data.Controller].includes(element))\n      .map((element) => callback(element))\n  }\n\n  listenForNewUninitializedControllersAtRuntime(callback: Callback) {\n    return new MutationObserver((mutations) =>\n      mutations.map(({ addedNodes }) => {\n        if (addedNodes.length > 0) {\n          addedNodes.forEach((node) => {\n            // Ignore non-elements\n            if (node.nodeType !== 1) return\n            // Don't listen for changes that happen in discovered controllers\n            if (node?.parentElement?.closest(Data.Controller)) return\n\n            this.discoverUninitializedControllers((el: Element) => {\n              this.initialize(el)\n            }, node.parentElement)\n          })\n        }\n      })\n    ).observe(document.querySelector('body'), {\n      childList: true,\n      attributes: true,\n      subtree: true,\n    })\n  }\n}\n","// https://github.com/stimulusjs/stimulus/blob/master/packages/%40stimulus/core/src/application.ts\nexport function domReady() {\n  return new Promise((resolve) => {\n    if (document.readyState == 'loading') {\n      document.addEventListener('DOMContentLoaded', resolve)\n    } else {\n      resolve()\n    }\n  })\n}\n\nexport const defaultEventNames = {\n  a: 'click',\n  button: 'click',\n  form: 'submit',\n  input: 'input',\n  select: 'change',\n  textarea: 'input',\n}\n","import { defaultEventNames } from './utils'\n\ntype Context = {\n  [key: string]: Function\n}\n\nexport default class Controller {\n  private dataAttr: string\n  private targetElements: NodeList\n  private actionElements: NodeList\n\n  private cache = {\n    'data-target': [],\n    'data-action': [],\n  }\n\n  private context: Context\n  private initCalled = false\n\n  constructor(element: Element, context: Context) {\n    this.context = context\n    this.dataAttr = element.getAttribute('data-controller')\n    this.targetElements = element.querySelectorAll('[data-target]')\n    this.actionElements = element.querySelectorAll('[data-action]')\n\n    this.updateCache(this.targetElements, 'data-target')\n    this.updateCache(this.actionElements, 'data-action')\n\n    this.invoke()\n\n    if (\n      this.context[this.dataAttr] &&\n      this.context[this.dataAttr]['init'] &&\n      typeof this.context[this.dataAttr]['init'] === 'function' &&\n      !this.initCalled\n    ) {\n      this.context[this.dataAttr]['init'](this.cache['data-target'])\n      this.initCalled = true\n    }\n  }\n\n  updateCache(elements: NodeList, attr: string) {\n    elements.forEach((element: Element) => {\n      this.cache = {\n        ...this.cache,\n        [attr]: { ...this.cache[attr], [element.getAttribute(attr)]: element },\n      }\n    })\n  }\n\n  invoke() {\n    this.actionElements.forEach((actionElement: Element) => {\n      const actions = actionElement.getAttribute('data-action')\n\n      // Make sure the attribute has an action\n      if (!actions || actions === '') {\n        throw new Error(\n          '[Embroidery]: An action attribute was specified without an action. Is the action an empty string or missing?'\n        )\n      }\n\n      // Actions are separated by a blank space\n      // Example: mouseover->dothis mouseout->dothat\n      actions.split(' ').map((action) => {\n        let event = null\n        let func = null\n\n        // We can assume some common actions by their tagname\n        // For example button has the default action click\n        if (!action.includes('->')) {\n          const tagName = actionElement.tagName.toLowerCase()\n          event = defaultEventNames[tagName]\n          func = action\n        } else {\n          ;[event, func] = action.split('->')\n        }\n\n        if (!event) {\n          throw new Error(\n            `[Embroidery]: Missing event on ${actionElement}, for example click or change.`\n          )\n        }\n\n        if (!func) {\n          throw new Error(\n            `[Embroidery]: Missing function on ${actionElement}. Specify your function in the controller.`\n          )\n        }\n        actionElement.addEventListener(event, () => {\n          // Invoke function\n          this.context[this.dataAttr][func](this.cache['data-target'])\n        })\n      })\n    })\n  }\n}\n"],"names":["Data","DataAttribute","defaultEventNames","a","button","form","input","select","textarea","Controller","element","context","this","data-target","data-action","dataAttr","getAttribute","targetElements","querySelectorAll","actionElements","updateCache","invoke","initCalled","cache","elements","attr","forEach","_this","actionElement","actions","Error","split","map","action","event","func","includes","tagName","toLowerCase","addEventListener","_this2","Embroidery","Partial","start","app","Promise","resolve","document","readyState","console","info","discover","el","initialize","register","controller","callback","type","e","dataset","Object","keys","_this3","error","setTimeout","discoverUninitializedControllers","parentElement","Array","from","filter","_this4","listenForNewUninitializedControllersAtRuntime","MutationObserver","mutations","addedNodes","length","node","nodeType","_node$parentElement","closest","_this5","observe","querySelector","childList","attributes","subtree"],"mappings":"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"}